#!/bin/bash

export PATH="/opt/homebrew/bin:$PATH"

ICON_FONT="JetBrainsMono Nerd Font Mono:Regular:15.0"
LABEL_FONT="SF Pro:Regular:14.0"
BOLD_FONT="SF Pro:Semibold:14.0"
TEXT="0xffd8dee9"
TEXT_ACTIVE="0xffffffff"
TEXT_DIM="0xff6b737d"

sketchybar --bar height=30 \
               blur_radius=30 \
               position=top \
               topmost=window \
               padding_left=12 \
               padding_right=12 \
               color=0xcc2e3440

sketchybar --default label.font="$LABEL_FONT" \
                     icon.font="$ICON_FONT" \
                     icon.color=$TEXT \
                     label.color=$TEXT \
                     padding_left=4 \
                     padding_right=4 \
                     background.drawing=off

# LEFT — focused app name + menu popup
sketchybar --add event window_focus
sketchybar --add item app_name left \
           --set app_name label.font="$BOLD_FONT" \
                          icon.drawing=off \
                          click_script="$HOME/.config/sketchybar/plugins/app_menu.sh toggle" \
                          script="$HOME/.config/sketchybar/plugins/app_name.sh" \
           --subscribe app_name window_focus

for i in $(seq 0 9); do
  sketchybar --add item "menu.$i" popup.app_name \
             --set "menu.$i" drawing=off \
                             label.font="$LABEL_FONT" \
                             click_script="$HOME/.config/sketchybar/plugins/app_menu.sh click $i"
done

# CENTER — workspace dots
sketchybar --add event aerospace_workspace_change

CURRENT=$(aerospace list-workspaces --focused 2>/dev/null)

for sid in $(aerospace list-workspaces --all); do
  HAS_WINDOWS=$(aerospace list-windows --workspace "$sid" 2>/dev/null | grep -c '.')

  if [ "$sid" = "$CURRENT" ]; then
    DRAW="on"; COLOR="0xff88c0d0"; FONT="SF Pro:Bold:14.0"
  elif [ "$HAS_WINDOWS" -gt 0 ]; then
    DRAW="on"; COLOR="0xff6b737d"; FONT="SF Pro:Regular:14.0"
  else
    DRAW="off"; COLOR="0xff6b737d"; FONT="SF Pro:Regular:14.0"
  fi

  sketchybar --add item space.$sid center \
    --subscribe space.$sid aerospace_workspace_change \
    --set space.$sid \
      label="$sid" \
      label.font="$FONT" \
      label.color=$COLOR \
      icon.drawing=off \
      drawing=$DRAW \
      click_script="aerospace workspace $sid" \
      script="$HOME/.config/sketchybar/plugins/aerospace.sh $sid"
done

# RIGHT — clock, battery, wifi, audio, keyboard, claude
sketchybar --add item clock right \
           --set clock update_freq=10 \
                       icon.drawing=off \
                       script="$HOME/.config/sketchybar/plugins/clock.sh"

sketchybar --add item battery right \
           --set battery update_freq=60 \
                         icon.y_offset=1 \
                         icon.padding_right=6 \
                         script="$HOME/.config/sketchybar/plugins/battery.sh" \
           --subscribe battery power_source_change

sketchybar --add item wifi right \
           --set wifi update_freq=30 \
                      icon.y_offset=1 \
                      icon.padding_right=6 \
                      script="$HOME/.config/sketchybar/plugins/wifi.sh"

sketchybar --add item audio right \
           --set audio update_freq=2 \
                       icon.y_offset=1 \
                       icon.padding_right=6 \
                       script="$HOME/.config/sketchybar/plugins/audio.sh"

sketchybar --add item keyboard right \
           --set keyboard update_freq=5 \
                          script="$HOME/.config/sketchybar/plugins/keyboard.sh"

sketchybar --add item claude right \
           --set claude icon="" \
                        icon.background.drawing=on \
                        icon.background.image="$HOME/.config/sketchybar/images/clawd.png" \
                        icon.background.image.drawing=on \
                        icon.background.image.scale=1.0 \
                        icon.background.height=22 \
                        icon.background.color=0x00000000 \
                        icon.width=47 \
                        icon.padding_left=4 \
                        icon.padding_right=8 \
                        label.drawing=off \
                        padding_right=20

sketchybar --update
